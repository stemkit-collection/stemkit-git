#!/bin/sh
# vim: ft=sh: sw=2:

unset FORCE

main () {
  root=`git ws` || {
    echo "ERROR: Not a git workspace: `pwd`" 1>&2
    exit 2
  }

  [ "${1}" = '-f' ] && {
    FORCE='=='
  }

  [ "${FORCE:+set}" = set ] || {
    echo "INFO: Simulation mode (dry-run), use -f to force the commands"
  }

  cd "${root}" && {
    run git worktree prune

    git branch | grep -v '^[*]' | while read line; do
      make_worktree ${line} || break
    done
  }
}

make_worktree () {
    top=${1}/src

    [ -e "${top}" ] && {
      echo "WARNING: Already exists: ${top}" 1>&2
      return 0
    }

    run git worktree add "${top}" "${1}"
}

run () {
  echo "${FORCE:-##} ${@}"

  [ "${FORCE:+set}" = set ] || {
    return 0
  }

  "${@}"
}

exec 5>/dev/null
main "${@}"
