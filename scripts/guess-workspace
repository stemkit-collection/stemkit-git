#!/bin/sh
# vim: ft=sh: sw=2:
# Author: Gennady Bystritsky (bystr@mac.com)

DESCEND=yes
LIST=no

unset OFFSET SAFE

main () {
  parse_command_line "${@}"

  git gfb-aliases-available 2>&5 || {
    import git && setup_git_environment
  }

  ROOT=`git ws 2>&5` || ROOT=`pwd`

  [ "${matchers:-no}" = no -a "${LIST}" = no ] && {
    echo "${ROOT}"
    return 0
  }

  [ "${DESCEND}" = yes ] && {
    OFFSET=`git from-top 2>&5`
  }

  available=`collect_available`
  matching=`output_filtered yes 1 '' ${available}`

  [ "${LIST}" = yes ] && {
    output_filtered no 1 '' ${matching}
    return 0
  }

  set -- ${matching}

  case ${#} in
    1)
      target=${ROOT}/${1}

      [ "${OFFSET:-.}" = . ] || {
        deep_target="${target}/${OFFSET}"
        [ -d "${deep_target}" ] && {
          output 1 "${deep_target}"
          return 0
        }
      }

      output 1 "${target}"
      return 0
    ;;

    0)
      error 'No workspaces for specification' ${matchers}
      output 2 'Available workspaces:'
      output_filtered no 2 '  ' ${available}
    ;;

    *)
      error 'Ambiguous workspace specification' ${matchers}
      output 2 'Matching workspaces:'
      output_filtered no 2 '  ' ${matching}
    ;;
  esac

  [ "${SAFE}" = yes ] && output 1 .
}

output_filtered () {
  filter=${1}
  stream=${2}
  indent=${3}

  shift 3

  for item in "${@}"; do
    [ "${filter}" = no ] || check_match "${item}" && {
      output "${stream}" "${indent}${item}"
    }
  done
}

collect_available () {
  git -C "${ROOT}" tt top 2>&5 | sed -n "s%^${ROOT}/%%p"
}


check_match () {
  for matcher in ${matchers}; do
    case "${1}" in
      *"${matcher}"* )
        continue
      ;;
    esac

    return 1
  done

  return 0
}

process_option () {
  option=${1}
  argument=${2}

  case "${option}" in
    --top | -t )
      DESCEND=no
    ;;

    --list | -l )
      LIST=yes
    ;;

    --safe | -s )
      SAFE=yes
    ;;

    *)
      process_standard_option "${@}"
    ;;
  esac
}

process_parameters () {
  matchers="${@}"
}

options_usage () {
  echo "`standard_options_usage` [--top|-t][--list|-l][--safe|-s][<matcher>...]"
}

. `type "${0}" | awk '{print $(NF)}' | xargs dirname`/core.sh.lib
start "${@}"
