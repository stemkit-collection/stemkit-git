#!/bin/sh
# vim: ft=sh: sw=2:
# Author: Gennady Bystritsky (bystr@mac.com)

unset DIRECTORY OFFSET

main () {
  parse_command_line "${@}"
  setup_git_environment

  ensure_git_workspace
  report_simulation_mode

  run git worktree prune

  process_branches `git branch --no-color | grep -v '^[*]'`
}

process_branches () {
  for branch in "${@}"; do
    make_worktree ${branch} || {
      warning 'Problems detected, check prior messages.'
    }
  done
}

make_worktree () {
  top=${DIRECTORY:-'.'}/${1}/${OFFSET:-'src'}

  [ -e "${top}" ] && {
    info "Already exists" "${top}"
    return 0
  }

  run git worktree add "${top}" "${1}"
}

process_option () {
  option=${1}
  argument=${2}

  case "${option}" in
    --directory | -d )
      DIRECTORY="${argument}"
      return 4
    ;;

    --offset | -o )
      OFFSET="${argument}"
      return 4
    ;;

    *)
      process_standard_option "${@}"
    ;;
  esac
}

process_parameters () {
  return ${#}
}

options_usage () {
  echo "`standard_options_usage`[--directory|-d <folder=.>][--offset|-o <folder=src>"
}

. `type "${0}" | awk '{print $(NF)}' | xargs dirname`/core.sh.lib
start import=ws,git "${@}"
